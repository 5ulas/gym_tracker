# Iron Log — Session Context

> This file exists so the AI assistant can quickly regain context across sessions.
> Updated: 2025-01-20

## Project Overview

**Iron Log** is a personal gym workout tracker PWA optimized for iPhone Safari "Add to Home Screen". Lightweight, no backend, all data in localStorage. Dark theme (#121212 bg, #007AFF primary), mobile-first for one-handed gym use.

## Tech Stack

Vanilla JavaScript, CSS3, HTML5. No frameworks, no build tools. PWA with manifest.json and Service Worker.

## File Structure

```
/Users/laurynas.jonusas/personal/ios_gym_tracker_pwa/
├── index.html          (PWA shell, Apple meta tags)
├── app.js              (~2109 lines — all app logic, routing, views)
├── style.css           (~1799 lines — dark theme, all component styles)
├── manifest.json       (PWA manifest, standalone, portrait)
├── sw.js               (Service Worker, cache-first, version "ironlog-v5")
├── .context.md         (this file)
└── icons/
    ├── icon-192.png
    └── icon-512.png
```

## Architecture

- **Router**: Hash-based with URL-encoded params (`#/routine/edit?id=abc123`). Uses `Router.on(path, handler)`, `Router.go(path, params)`. Has `_buildHash()` and `_parseHash()` methods. Uses `_skipNextHashChange` flag to prevent double-firing on `go()`.
- **Store**: localStorage wrapper with methods: `getExercises()`, `saveExercises()`, `getRoutines()`, `saveRoutines()`, `getWorkouts()`, `saveWorkouts()`, `getActiveWorkout()`, `saveActiveWorkout()`, `clearActiveWorkout()`
- **Views**: Functions that call `render(html)` to set `#app` innerHTML, then wire up event listeners via `addEventListener`.
- **Data keys**: `il_exercises`, `il_routines`, `il_workouts`, `il_active_workout`

## All Routes (12 total)

| Route               | Handler              | Description                                          |
| ------------------- | -------------------- | ---------------------------------------------------- |
| `/`                 | `viewRoutines`       | Home — routine cards with play button, resume banner |
| `/exercises`        | `viewExercises`      | Exercise library — search, filter, tap to detail     |
| `/exercise/new`     | `viewAddExercise`    | Add custom exercise form                             |
| `/exercise/detail`  | `viewExerciseDetail` | Exercise info, edit/delete buttons, progress link    |
| `/exercise/edit`    | `viewExerciseEdit`   | Edit exercise form, propagates to routines           |
| `/routine/new`      | `viewRoutineEditor`  | Create routine — name, add/reorder exercises         |
| `/routine/edit`     | `viewRoutineEditor`  | Edit existing routine (same view, `params.id` set)   |
| `/workout/active`   | `viewActiveWorkout`  | Active workout — one exercise at a time, log sets    |
| `/workout/summary`  | `viewWorkoutSummary` | Post-workout summary stats                           |
| `/history`          | `viewHistory`        | Past workouts grouped by month, progress chart links |
| `/history/workout`  | `viewWorkoutDetail`  | Full breakdown of a past workout                     |
| `/history/progress` | `viewProgress`       | Per-exercise SVG charts (weight, est. 1RM)           |

## Data Shapes

```js
// Exercise (in il_exercises):
{ id, name, muscle, equipment }

// Routine (in il_routines):
{ id, name, exercises: [{ id, name, muscle, equipment }] }

// Active workout (il_active_workout):
{ id, routineId, routineName, startedAt, currentExerciseIdx,
  exercises: [{ id, name, muscle, equipment, notes,
    sets: [{ weight, reps, difficulty, loggedAt }] }] }

// Completed workout (in il_workouts array):
{ id, routineId, routineName, startedAt, finishedAt, duration,
  exercises: [{ id, name, muscle, equipment, notes,
    sets: [{ weight, reps, difficulty, loggedAt }] }] }
```

## Key Helpers

- `esc(s)` — XSS escape, used on all user-provided strings rendered as HTML
- `uid()` — generates `id_<timestamp36>_<random>`
- `muscleIcon(muscle)` — returns emoji for muscle group
- `tabBar(active)` — renders bottom nav (Routines, History, Exercises)
- `render(html)` — sets `#app` innerHTML (destroys all DOM/listeners)
- `formatDuration(ms)`, `formatTimer(seconds)`, `formatDate(ts)`, `timeAgo(ts)`
- `getLastPerformance(exerciseId)` — finds last workout's sets for an exercise
- `getDefaultWeight/Reps(exercise, lastPerf)` — smart defaults using current set index
- `renderLineChart(containerId, values, labels)` — SVG line chart renderer

## Completed Features (All Working)

### Phase 1 — Foundation

- 15 pre-populated exercises, searchable, filterable by muscle group
- Add custom exercises
- Routine creator: name, search/add exercises, drag-to-reorder, edit/delete
- PWA: manifest.json, service worker (v5), offline caching, Apple meta tags
- Bottom tab bar: Routines, History, Exercises

### Phase 2 — Active Logger

- Start workout from routine card play button
- Active workout: one exercise at a time, progress bar, elapsed timer
- Set logging: weight/reps inputs, Easy/Medium/Hard difficulty (face SVG buttons)
- Smart set defaults: auto-fills from matching set index of last performance
- Rest timer: circular SVG countdown (60/90/120s by difficulty), skip/adjust, vibrate
- Per-exercise notes: collapsible textarea, auto-saves, shown in summary/detail
- Exercise navigation: prev/next, finish button on last exercise
- Workout summary: stats cards, exercise breakdown with difficulty badges & notes
- Resume banner: pulsing blue banner on home when workout in progress

### Phase 3 — History & Progress

- History view: past workouts grouped by month, stats, muscle tags
- Workout detail: full breakdown, delete button, progress links per exercise, notes display
- Progress view: per-exercise SVG line charts (best weight, est. 1RM via Epley), stats grid, session history table

### Phase 4 — Upgrades (Latest)

- XSS escaping via `esc()` on all user-provided strings
- Router params encoded in URL hash (back/forward works)
- Exercise detail view with edit/delete/progress actions
- Exercise edit view (propagates changes to all routines)
- Exercise delete (warns if used in routines, removes from them)
- Exercise library items tappable (navigate to detail view)

## Bugs Previously Fixed

1. **Orphaned code block** — ~250 lines of routine editor code at top-level scope caused ReferenceError. Removed.
2. **Router double-fire** — `go()` triggered both hashchange + direct handler call. Fixed with `_skipNextHashChange` flag.
3. **Router params lost on back/forward** — Params now encoded in hash URL and parsed in hashchange handler.

## Important Implementation Notes

- **Inline `onclick` vs `addEventListener`**: Mix used. Tab bar, back buttons, workout controls use inline `onclick`. Forms and complex interactions use `addEventListener` after render.
- **The `selected` array in routine editor**: Passed by reference through render cycle. Mutations persist across rerenders.
- **`render()` destroys DOM**: Views must re-bind listeners after calling `render()`.
- **Exercise IDs**: Default exercises use `ex1`-`ex15`. Custom exercises use `uid()`.
- **CSS classes**: `.exercise-item`, `.ex-icon`, `.ex-info`, `.ex-name`, `.ex-meta`, `.btn-icon`, `.btn-primary`, `.btn-full`, `.btn-back`, `.form`, `.form-label`, `.form-input`, `.summary-exercise`, `.summary-ex-name`, `.workout-notes`, `.notes-toggle`, `.notes-textarea`, `.summary-notes`, `.exercise-detail-card`, `.detail-actions`, `.btn-detail-action`, etc.

## Local Development

```bash
# Start server
python3 -m http.server 8080

# Open in browser
open http://localhost:8080/

# Syntax check
node --check app.js
```

After changing files, bump the SW cache version in `sw.js` (currently `ironlog-v5`) and hard-refresh or clear the service worker.
